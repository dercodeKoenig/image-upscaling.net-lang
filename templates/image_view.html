<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="robots" content="noindex">

    <title>Image Preview</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: sans-serif;
        }

       .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            background: radial-gradient(ellipse at center, rgba(0, 123, 255, 0.15) 0%, rgba(0, 0, 0, 0) 80%);
            border-radius: 12px;
            box-shadow: 0 0 40px rgba(0, 123, 255, 0.15);
        }

        img {
            max-height: 80vh;
            max-width: 100vw;
            object-fit: contain;
            border-radius: 8px;
        }


        button {
            padding: 0.6em 1.2em;
            font-size: 1rem;
            background-color: green;
            color: white;
            border: 1px solid #444;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        button:hover {
            background-color: darkgreen;
        }

        .loader {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 80vw;
          max-width: 400px;
          background: rgba(0, 0, 0, 0.85);
          padding: 1rem 1.5rem;
          border-radius: 12px;
          box-shadow: 0 0 20px rgba(0, 123, 255, 0.8);
          text-align: center;
          z-index: 9999;
          user-select: none;
          color: #00c6ff;
          font-weight: 600;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .loading-text {
          margin-bottom: 0.8rem;
          font-size: 1.1rem;
        }

        .bar-container {
          width: 100%;
          height: 14px;
          background-color: #222;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: inset 0 0 8px rgba(0, 123, 255, 0.5);
        }

        .bar {
          height: 100%;
          width: 0%;
          background: linear-gradient(90deg, #00c6ff, #0072ff);
          border-radius: 10px;
          transition: width 0.1s ease;
          box-shadow: 0 0 8px #00c6ff;
        }


    </style>
</head>
<body>
<div class="loader" id="loader">
    <div class="loading-text">Loading image...</div>
    <div class="bar-container">
        <div class="bar" id="progressBar"></div>
    </div>
</div>
<div class="container" style="display:none" id="image_container">
    <div id="zoom-wrapper" style="overflow: hidden; max-height: 80vh; max-width: 100vw; position: relative;">
        <img id="preview" alt="Loading..." style="transform-origin: center center; cursor: grab;">
    </div>
    <button id="downloadBtn">Download</button>
</div>

<script>
    const imageUrl = new URLSearchParams(window.location.search).get("src");
    const img = document.getElementById("preview");
    const downloadBtn = document.getElementById("downloadBtn");
    const loader = document.getElementById("loader");
    const progressBar = document.getElementById("progressBar");
    const image_container = document.getElementById("image_container");

    if (!imageUrl) {
        alert("No image URL provided.");
    } else {
        fetch(imageUrl)
            .then(response => {
                if (!response.ok) throw new Error("Image fetch failed.");

                const contentLength = response.headers.get("Content-Length");
                if (!contentLength) {
                    console.warn("No content length â€” cannot show progress.");
                    return response.blob(); // fallback
                }

                const total = parseInt(contentLength, 10);
                let loaded = 0;

                const reader = response.body.getReader();
                const chunks = [];

                function updateProgress() {
                    const percent = Math.round((loaded / total) * 100);
                    progressBar.style.width = percent + "%";
                }

                return new ReadableStream({
                    start(controller) {
                        function push() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    controller.close();
                                    return;
                                }
                                chunks.push(value);
                                loaded += value.length;
                                updateProgress();
                                controller.enqueue(value);
                                push();
                            });
                        }
                        push();
                    }
                });
            })
            .then(stream => {
                if (!stream) return;

                return new Response(stream).blob();
            })
            .then(blob => {
                const objectUrl = URL.createObjectURL(blob);
                img.src = objectUrl;

                loader.style.display = "none";
                image_container.style.display = "";

                downloadBtn.addEventListener('click', () => {
                    const a = document.createElement('a');
                    a.href = objectUrl;
                    a.download = imageUrl.split('/').pop().split('?')[0] || "image.jpg";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    downloadBtn.style.backgroundColor = "darkGreen"

                });
            })
            .catch(err => {
                console.error("Error:", err);
                img.alt = "Failed to load image.";
                loader.style.display = "none";
            });
    }





    // === Zooming and Panning Logic ===
let scale = 1;
let pos = { x: 0, y: 0 };
let isDragging = false;
let start = { x: 0, y: 0 };

const zoomWrapper = document.getElementById('zoom-wrapper');

img.addEventListener('wheel', (e) => {
    e.preventDefault();

    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    scale = Math.min(Math.max(0.2, scale + delta), 5);

    img.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`;
});

// Drag to Pan
img.addEventListener('mousedown', (e) => {
    e.preventDefault()
    isDragging = true;
    start.x = e.clientX - pos.x;
    start.y = e.clientY - pos.y;
    img.style.cursor = 'grabbing';
});

window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    pos.x = e.clientX - start.x;
    pos.y = e.clientY - start.y;
    img.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`;
});

window.addEventListener('mouseup', () => {
    isDragging = false;
    img.style.cursor = 'grab';
});

</script>

</body>
</html>
